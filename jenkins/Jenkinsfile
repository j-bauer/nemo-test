#!/usr/bin/env groovy

def cluster = [cpus: "20",
               mem: "120g",
               prefix: "/home/jenkins/software",
               modules_prefix: "/home/jenkins/software/modules",
               software_prefix: "/home/jenkins/software/software",
               easybuild_path: "/home/jenkins/easybuild/modules/all"]

def running_opts = ""

def vars = [:]

pipeline {
    agent { label 'mg2'}
    stages {
        stage('GetVars') {
            steps {
                script {
                    gitVars = checkout scm
                    vars.workingDir = sh(returnStdout: true,
                        script: 'echo $PWD').trim()
                    vars.branch = gitVars.GIT_BRANCH.trim()
                    vars.triggeredBy = currentBuild.getBuildCauses()[0].shortDescription.split(' ')[2]
                    vars.commitMessage = sh(returnStdout: true, script: 'git log -1 --pretty=format:%s').trim()
                    vars.differences = sh(returnStdout: true, script: 'git diff origin/master...HEAD --name-only --oneline --no-merges --diff-filter=ACMRTUXB |grep ^easybuild\\/easyconfigs\\/.*\\.eb\\\$ | wc -l').trim() as Integer
                    vars.regression = "False"
                    echo "$vars"
                }
            }
        }
        stage('TestBuild'){
            when {
                expression { 
                    vars.differences > 0 && 
                    vars.branch != "origin/master" && 
                    vars.branch != "origin/develop" 
                }
            }
            steps {
                script {
                    running_opts += " --prefix=${vars.workingDir}/software"
                    running_opts += " --list=${vars.workingDir}/${build_id}"
                    running_opts += " --use=${cluster.modules_prefix}/all"
                    running_opts += " --eb-path=${cluster.easybuild_path}"
                    sh("""git diff origin/master...HEAD --name-only --oneline --no-merges --diff-filter=ACMRTUXB |grep ^easybuild\\/easyconfigs\\/.*\\.eb\\\$ |awk '{print \"basename \"\$0}' > ${softwareList}""")
                    command = "srun --partition=1d --cpus-per-task=$cluster.cpus --mem=$cluster.mem $vars.workingDir/jenkins/production.sh $running_opts"
                    sh("""$command""")
                }
            }    
        }
        stage('Prepare Build'){
            when {
                expression{
                    vars.branch == "origin/master" ||
                    vars.branch == "origin/develop"
                }
            }
            steps {
                script {
                    running_opts += " --list=Template"
                    running_opts += " --hide-deps"
                    running_opts += " --eb-path=${cluster.easybuild_path}"
                    // Case Regress
                    if (vars.triggeredBy == "timer" || vars.commitMessage ==~ /.*REGRESSION.*/ ) {
                        echo "Detecting regression"
                        running_opts += " --prefix=${vars.workingDir}/software"
                        vars.regression = "True"
                    } else {
                        vars.regression = "False"
                        if (vars.branch == "origin/master"){ // Case master
                            running_opts += " --prefix=${cluster.prefix}"
                            running_opts += " --soft-prefix=${cluster.software_prefix}"
                            running_opts += " --modules-prefix=${cluster.modules_prefix}"
                        } else if( vars.branch == "origin/develop"){
                            //Do rsync and put new prefixes...
                            running_opts += " --prefix=${vars.workingDir}/software"
                        }
                    }
                }
            }
        }
        stage('Build'){
            when {
                expression {
                    (vars.branch == "origin/master" ||
                    vars.branch == "origin/develop")
                }
                expression {
                    vars.regression == "False"
                }
            }
            steps {
                script {
                    command = "srun --partition=1d --cpus-per-task=$cluster.cpus --mem=$cluster.mem $vars.workingDir/jenkins/production.sh $running_opts"
                    sh("""$command""")
                }
            }
        }
        stage('Regression'){
            when {
                expression {
                    (vars.branch == "origin/master" ||
                    vars.branch == "origin/develop") 
                }
                expression {
                    vars.regression == "True"
                }
            }
            steps {
                script {
                    command = "srun --partition=1d --cpus-per-task=$cluster.cpus --mem=$cluster.mem $vars.workingDir/jenkins/production.sh $running_opts"
                    sh("""$command""")
                }
            }
        }
    }
}